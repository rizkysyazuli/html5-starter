/*
 * jQuery Address Plugin v1.4
 * http://www.asual.com/jquery/address/
 *
 * Copyright (c) 2009-2010 Rostislav Hristov
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Date: 2011-03-24 15:44:33 +0700 (Thu, 24 Mar 2011)
 */
(function(c){c.address=function(){var v=function(a){c(c.address).trigger(c.extend(c.Event(a),function(){for(var b={},e=c.address.parameterNames(),f=0,q=e.length;f<q;f++)b[e[f]]=c.address.parameter(e[f]);return{value:c.address.value(),path:c.address.path(),pathNames:c.address.pathNames(),parameterNames:e,parameters:b,queryString:c.address.queryString()}}.call(c.address)))},w=function(a,b,e){c(c.address).bind(a,b,e);return c.address},r=function(){return N.pushState&&d.state!==k},s=function(){return("/"+
g.pathname.replace(new RegExp(d.state),"")+g.search+(E()?"#"+E():"")).replace(V,"/")},E=function(){var a=g.href.indexOf("#");return a!=-1?C(g.href.substr(a+1),l):""},t=function(){return r()?s():E()},ga=function(){return"javascript"},O=function(a){a=a.toString();return(d.strict&&a.substr(0,1)!="/"?"/":"")+a},C=function(a,b){if(d.crawlable&&b)return(a!==""?"!":"")+a;return a.replace(/^\!/,"")},x=function(a,b){return parseInt(a.css(b),10)},W=function(a){for(var b,e,f=0,q=a.childNodes.length;f<q;f++){try{if(a.childNodes[f].src)b=
String(a.childNodes[f].src)}catch(K){}if(e=W(a.childNodes[f]))b=e}return b},G=function(){if(!L){var a=t();if(h!=a)if(y&&p<7)g.reload();else{y&&p<8&&d.history&&u(P,50);h=a;F(l)}}},F=function(a){v(X);v(a?Y:Z);u($,10)},$=function(){if(d.tracker!=="null"&&d.tracker!==null){var a=c.isFunction(d.tracker)?d.tracker:j[d.tracker],b=(g.pathname+g.search+(c.address&&!r()?c.address.value():"")).replace(/\/\//,"/").replace(/^\/$/,"");if(c.isFunction(a))a(b);else if(c.isFunction(j.urchinTracker))j.urchinTracker(b);
else if(j.pageTracker!==k&&c.isFunction(j.pageTracker._trackPageview))j.pageTracker._trackPageview(b);else j._gaq!==k&&c.isFunction(j._gaq.push)&&j._gaq.push(["_trackPageview",decodeURI(b)])}},P=function(){var a=ga()+":"+l+";document.open();document.writeln('<html><head><title>"+o.title.replace("'","\\'")+"</title><script>var "+D+' = "'+encodeURIComponent(t())+(o.domain!=g.hostname?'";document.domain="'+o.domain:"")+"\";<\/script></head></html>');document.close();";if(p<7)m.src=a;else m.contentWindow.location.replace(a)},
ba=function(){if(H&&aa!=-1){var a,b=H.substr(aa+1).split("&");for(i=0;i<b.length;i++){a=b[i].split("=");if(/^(autoUpdate|crawlable|history|strict|wrap)$/.test(a[0]))d[a[0]]=isNaN(a[1])?/^(true|yes)$/i.test(a[1]):parseInt(a[1],10)!==0;if(/^(state|tracker)$/.test(a[0]))d[a[0]]=a[1]}H=null}h=t()},da=function(){if(!ca){ca=n;ba();var a=function(){ha.call(this);ia.call(this)},b=c("body").ajaxComplete(a);a();if(d.wrap){c("body > *").wrapAll('<div style="padding:'+(x(b,"marginTop")+x(b,"paddingTop"))+"px "+
(x(b,"marginRight")+x(b,"paddingRight"))+"px "+(x(b,"marginBottom")+x(b,"paddingBottom"))+"px "+(x(b,"marginLeft")+x(b,"paddingLeft"))+'px;" />').parent().wrap('<div id="'+D+'" style="height:100%;overflow:auto;position:relative;'+(I&&!window.statusbar.visible?"resize:both;":"")+'" />');c("html, body").css({height:"100%",margin:0,padding:0,overflow:"hidden"});I&&c('<style type="text/css" />').appendTo("head").text("#"+D+"::-webkit-resizer { background-color: #fff; }")}if(y&&p<8){a=o.getElementsByTagName("frameset")[0];
m=o.createElement((a?"":"i")+"frame");if(a){a.insertAdjacentElement("beforeEnd",m);a[a.cols?"cols":"rows"]+=",0";m.noResize=n;m.frameBorder=m.frameSpacing=0}else{m.style.display="none";m.style.width=m.style.height=0;m.tabIndex=-1;o.body.insertAdjacentElement("afterBegin",m)}u(function(){c(m).bind("load",function(){var e=m.contentWindow;h=e[D]!==k?decodeURIComponent(e[D]):"";if(h!=t()){F(l);g.hash=C(h,n)}});m.contentWindow[D]===k&&P()},50)}u(function(){v("init");F(l)},1);if(!r())if(y&&p>7||!y&&"on"+
J in j)if(j.addEventListener)j.addEventListener(J,G,l);else j.attachEvent&&j.attachEvent("on"+J,G);else ja(G,50)}},ha=function(){var a,b=c("a"),e=b.size(),f=-1;u(function(){if(++f!=e){a=c(b.get(f));a.is('[rel*="address:"]')&&a.address();u(arguments.callee,1)}},1)},ka=function(){if(h!=t()){h=t();F(l)}},la=function(){if(j.removeEventListener)j.removeEventListener(J,G,l);else j.detachEvent&&j.detachEvent("on"+J,G)},ia=function(){if(d.crawlable){var a=g.pathname.replace(/\/$/,"");c("body").html().indexOf("_escaped_fragment_")!=
-1&&c('a[href]:not([href^=http]), a[href*="'+document.domain+'"]').each(function(){var b=c(this).attr("href").replace(/^http:/,"").replace(new RegExp(a+"/?$"),"");if(b===""||b.indexOf("_escaped_fragment_")!=-1)c(this).attr("href","#"+b.replace(/\/(.*)\?_escaped_fragment_=(.*)$/,"!$2"))})}},k,D="jQueryAddress",J="hashchange",X="change",Y="internalChange",Z="externalChange",n=true,l=false,d={autoUpdate:n,crawlable:l,history:n,strict:n,wrap:l},z=c.browser,p=parseFloat(c.browser.version),ea=z.mozilla,
y=z.msie,A=z.opera,I=z.webkit||z.safari,Q=l,j=function(){try{return top.document!==k?top:window}catch(a){return window}}(),o=j.document,N=j.history,g=j.location,ja=setInterval,u=setTimeout,V=/\/{2,9}/g;z=navigator.userAgent;var m,H=W(document),aa=H?H.indexOf("?"):-1,R=o.title,L=l,ca=l,S=n,fa=n,M=l,h=t();if(y){p=parseFloat(z.substr(z.indexOf("MSIE")+4));if(o.documentMode&&o.documentMode!=p)p=o.documentMode!=8?7:8;c(document).bind("propertychange",function(){if(o.title!=R&&o.title.indexOf("#"+t())!=
-1)o.title=R})}if(Q=ea&&p>=1||y&&p>=6||A&&p>=9.5||I&&p>=523){if(A)history.navigationMode="compatible";if(document.readyState=="complete")var ma=setInterval(function(){if(c.address){da();clearInterval(ma)}},50);else{ba();c(da)}A=s();if(d.state!==k)if(N.pushState)A.substr(0,3)=="/#/"&&g.replace(d.state.replace(/^\/$/,"")+A.substr(2));else A!="/"&&A.replace(/^\/#/,"")!=E()&&g.replace(d.state.replace(/^\/$/,"")+"/#"+A);c(window).bind({popstate:ka,unload:la})}else!Q&&E()!==""?g.replace(g.href.substr(0,
g.href.indexOf("#"))):$();return{bind:function(a,b,e){return w(a,b,e)},init:function(a){return w("init",a)},change:function(a){return w(X,a)},internalChange:function(a){return w(Y,a)},externalChange:function(a){return w(Z,a)},baseURL:function(){var a=g.href;if(a.indexOf("#")!=-1)a=a.substr(0,a.indexOf("#"));if(/\/$/.test(a))a=a.substr(0,a.length-1);return a},autoUpdate:function(a){if(a!==k){d.autoUpdate=a;return this}return d.autoUpdate},crawlable:function(a){if(a!==k){d.crawlable=a;return this}return d.crawlable},
history:function(a){if(a!==k){d.history=a;return this}return d.history},state:function(a){if(a!==k){d.state=a;return this}return d.state},strict:function(a){if(a!==k){d.strict=a;return this}return d.strict},tracker:function(a){if(a!==k){d.tracker=a;return this}return d.tracker},wrap:function(a){if(a!==k){d.wrap=a;return this}return d.wrap},update:function(){M=n;this.value(h);M=l;return this},title:function(a){if(a!==k){u(function(){R=o.title=a;if(fa&&m&&m.contentWindow&&m.contentWindow.document){m.contentWindow.document.title=
a;fa=l}if(!S&&ea)g.replace(g.href.indexOf("#")!=-1?g.href:g.href+"#");S=l},50);return this}return o.title},value:function(a){if(a!==k){a=O(a);if(a=="/")a="";if(h==a&&!M)return;S=n;h=a;if(d.autoUpdate||M){F(n);if(r())N[d.history?"pushState":"replaceState"]({},"",d.state.replace(/\/$/,"")+(h===""?"/":h));else{L=n;if(I)if(d.history)g.hash="#"+C(h,n);else g.replace("#"+C(h,n));else if(h!=t())if(d.history)g.hash="#"+C(h,n);else g.replace("#"+C(h,n));y&&p<8&&d.history&&u(P,50);if(I)u(function(){L=l},1);
else L=l}}return this}if(!Q)return null;return O(h)},path:function(a){if(a!==k){var b=this.queryString(),e=this.hash();this.value(a+(b?"?"+b:"")+(e?"#"+e:""));return this}return O(h).split("#")[0].split("?")[0]},pathNames:function(){var a=this.path(),b=a.replace(V,"/").split("/");if(a.substr(0,1)=="/"||a.length===0)b.splice(0,1);a.substr(a.length-1,1)=="/"&&b.splice(b.length-1,1);return b},queryString:function(a){if(a!==k){var b=this.hash();this.value(this.path()+(a?"?"+a:"")+(b?"#"+b:""));return this}a=
h.split("?");return a.slice(1,a.length).join("?").split("#")[0]},parameter:function(a,b,e){var f,q;if(b!==k){var K=this.parameterNames();q=[];b=b?b.toString():"";for(f=0;f<K.length;f++){var T=K[f],B=this.parameter(T);if(typeof B=="string")B=[B];if(T==a)B=b===null||b===""?[]:e?B.concat([b]):[b];for(var U=0;U<B.length;U++)q.push(T+"="+B[U])}c.inArray(a,K)==-1&&b!==null&&b!==""&&q.push(a+"="+b);this.queryString(q.join("&"));return this}if(b=this.queryString()){e=[];q=b.split("&");for(f=0;f<q.length;f++){b=
q[f].split("=");b[0]==a&&e.push(b.slice(1).join("="))}if(e.length!==0)return e.length!=1?e:e[0]}},parameterNames:function(){var a=this.queryString(),b=[];if(a&&a.indexOf("=")!=-1){a=a.split("&");for(var e=0;e<a.length;e++){var f=a[e].split("=")[0];c.inArray(f,b)==-1&&b.push(f)}}return b},hash:function(a){if(a!==k){this.value(h.split("#")[0]+(a?"#"+a:""));return this}a=h.split("#");return a.slice(1,a.length).join("#")}}}();c.fn.address=function(v){if(!c(this).attr("address")){var w=function(r){if(r.shiftKey||
r.ctrlKey||r.metaKey)return true;if(c(this).is("a")){var s=v?v.call(this):/address:/.test(c(this).attr("rel"))?c(this).attr("rel").split("address:")[1].split(" ")[0]:c.address.state()!==undefined&&c.address.state()!="/"?c(this).attr("href").replace(new RegExp("^(.*"+c.address.state()+"|\\.)"),""):c(this).attr("href").replace(/^(#\!?|\.)/,"");c.address.value(s);r.preventDefault()}};c(this).click(w).live("click",w).live("submit",function(r){if(c(this).is("form")){var s=c(this).attr("action");s=v?v.call(this):
(s.indexOf("?")!=-1?s.replace(/&$/,""):s+"?")+c(this).serialize();c.address.value(s);r.preventDefault()}}).attr("address",true)}return this}})(jQuery);
